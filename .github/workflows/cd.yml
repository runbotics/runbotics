name: CD

on:
  push:
    branches: ['test-md-502']
  workflow_dispatch:

env:
  RUSH: node ../common/scripts/install-run-rush.js
  NODE_VERSION: 18.x

jobs:
  changes-detection:
    runs-on: ubuntu-latest

    outputs:
      scheduler: ${{ steps.filter.outputs.scheduler }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Assign paths to scenarios
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            scheduler:
              - 'runbotics/runbotics-scheduler/package.json'

  push-scheduler:
    needs: changes-detection
    if: |
      needs.changes-detection.outputs.scheduler == 'true'

    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./runbotics/runbotics-scheduler

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update .npmrc
        shell: bash
        run: |
          echo -en "\n@runbotics:registry=https://npm.pkg.github.com\n//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ../common/config/rush/.npmrc

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Install dependencies
        run: $RUSH install -t .

      - name: Build
        run: $RUSH rebuild -t .

      - name: Rush deploy
        run: |
          mkdir -p ../common/deploy/runbotics-scheduler
          $RUSH deploy --scenario runbotics-scheduler \
            --target-folder ../common/deploy/runbotics-scheduler \
            --overwrite

      - name: Assign package version
        uses: nyaa8/package-version@v1
        with:
          path: './runbotics/runbotics-scheduler/package.json'

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./runbotics/common/deploy/runbotics-scheduler
          file: ./runbotics/common/deploy/runbotics-scheduler/Dockerfile
          push: true
          tags: |
            runbotics/runbotics-scheduler:latest
            runbotics/runbotics-scheduler:${{ env.PACKAGE_VERSION }}
